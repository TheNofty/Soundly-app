<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
</head>
<body style="background:#121212; color:#fff; display:flex; align-items:center; justify-content:center; height:100vh; font-family:sans-serif; margin:0;">
    <div style="text-align:center;">
        <h2 id="status">Creating your account...</h2>
        <div id="loader" style="width:30px; height:30px; border:3px solid #333; border-top:3px solid #fff; border-radius:50%; animation:spin 1s linear infinite; margin:20px auto;"></div>
    </div>

    <style>@keyframes spin { to { transform: rotate(360deg); } }</style>

    <script>
        const firebaseConfig = { 
            apiKey: "AIzaSyBDPN0hk9ZZbOdeHirFz2z_M8XGmNMpPVk", 
            authDomain: "soundly-e318d.firebaseapp.com", 
            projectId: "soundly-e318d",
            storageBucket: "soundly-e318d.firebasestorage.app",
            messagingSenderId: "452438627644",
            appId: "1:452438627644:web:62bdebcad4b145e3883a39"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const urlParams = new URLSearchParams(window.location.search);
        // МЕНЯЕМ session на token
        const token = urlParams.get('token');

        if(token) {
            // ИЩЕМ В pending_registrations
            db.collection("pending_registrations").doc(token).get().then(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    
                    auth.createUserWithEmailAndPassword(data.email, data.pass).then(cred => {
                        db.collection("users").doc(cred.user.uid).set({
                            nickname: data.nick,
                            email: data.email,
                            credits: 0,
                            subscription: "Нет",
                            reg_date: new Date().toLocaleDateString(),
                            avatar_id: Math.floor(Math.random() * 6) + 1
                        }).then(() => {
                            // Удаляем временный токен
                            db.collection("pending_registrations").doc(token).delete();
                            document.getElementById('status').innerText = "DONE! Redirecting...";
                            setTimeout(() => { window.location.href = "index.html"; }, 1500);
                        });
                    }).catch(err => {
                        document.getElementById('status').innerText = "Error: " + err.message;
                    });
                } else {
                    document.getElementById('status').innerText = "Link invalid or expired.";
                }
            });
        } else {
            document.getElementById('status').innerText = "No token found.";
        }
    </script>
</body>
</html>