<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Soundly | Verification</title>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <style>
        body { background: #050505 !important; color: white; font-family: sans-serif; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        .status-card { text-align: center; padding: 40px; background: #111; border: 1px solid #222; border-radius: 20px; width: 350px; }
        .logo-box { width: 60px; height: 60px; margin: 0 auto 20px; }
        h1 { font-size: 20px; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 2px; }
        p { color: #888; font-size: 14px; line-height: 1.5; }
        #loader { width: 30px; height: 30px; border: 3px solid #333; border-top: 3px solid #fff; border-radius: 50%; animation: spin 1s linear infinite; margin: 20px auto 0; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="status-card">
        <div class="logo-box"><img src="../Interface/Icons/Top_ui/Logo.png" width="100%" alt="Soundly"></div>
        <h1 id="main-msg">Confirming...</h1>
        <p id="sub-msg">Verification in progress. Please wait.</p>
        <div id="loader"></div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBDPN0hk9ZZbOdeHirFz2z_M8XGmNMpPVk",
            authDomain: "soundly-e318d.firebaseapp.com",
            projectId: "soundly-e318d",
            storageBucket: "soundly-e318d.firebasestorage.app",
            messagingSenderId: "452438627644",
            appId: "1:452438627644:web:62bdebcad4b145e3883a39"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        function getMoscowDate() {
            const opt = { timeZone: "Europe/Moscow", day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', hour12: false };
            let raw = new Date().toLocaleString("ru-RU", opt);
            return raw.replace(', ', ' (').replace(',', ' (') + ')'; 
        }

        const token = new URLSearchParams(window.location.search).get('token');

        if (token) {
            db.collection("pending_registrations").doc(token).get().then(async (doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    try {
                        const cred = await auth.createUserWithEmailAndPassword(data.email, data.pass);
                        await db.collection("users").doc(cred.user.uid).set({
                            nickname: data.nick,
                            email: data.email,
                            credits: 0,
                            subscription: "械",
                            reg_date: getMoscowDate(),
                            avatar_id: 1,
                            is_verified: true //  效蝎 挟效-校小
                        });
                        await db.collection("pending_registrations").doc(token).delete();
                        
                        document.getElementById('main-msg').innerText = "EMAIL VERIFIED";
                        document.getElementById('sub-msg').innerText = "Account created. You can now close this tab and return to the app.";
                        document.getElementById('loader').style.display = "none";
                    } catch (e) {
                        document.getElementById('main-msg').innerText = "AUTH ERROR";
                        document.getElementById('sub-msg').innerText = e.message;
                    }
                } else {
                    document.getElementById('main-msg').innerText = "LINK EXPIRED";
                    document.getElementById('sub-msg').innerText = "This registration link is no longer valid.";
                    document.getElementById('loader').style.display = "none";
                }
            }).catch(e => {
                document.getElementById('main-msg').innerText = "SERVER ERROR";
            });
        }
    </script>
</body>
</html>